\RequirePackage{tikz}
\RequirePackage{trek-shapes}

\mode<presentation>

\makeatletter

% Basic dimensions of the trek theme
\newdimen\trek@margin
\newdimen\trek@titlegap
\newdimen\trek@elbow@height
\newdimen\trek@elbow@outer@radius
\newdimen\trek@elbow@inner@radius
\newdimen\trek@cursorwidth
\newdimen\trek@sidebar@width
\trek@margin=2mm
\trek@titlegap=0.8mm
\trek@elbow@height=10mm
\trek@elbow@outer@radius=4mm
\trek@elbow@inner@radius=2mm
\trek@cursorwidth=5mm
\trek@sidebar@width=10mm

% Derived dimensions
\newdimen\trek@full@sidebar@width
\trek@full@sidebar@width=\trek@sidebar@width
\advance \trek@full@sidebar@width by \trek@margin
\advance \trek@full@sidebar@width by \trek@margin

\setbeamersize{sidebar width left=\the\trek@full@sidebar@width}

\defbeamertemplate*{headline}{trek theme}{}

\defbeamertemplate*{navigation symbols}{trek theme}{}

\defbeamertemplate*{frametitle}{trek theme}
{%
  % Measure height and width of the frametitle text
  \newdimen\@titletextwidth%
  \newdimen\@titletextheight%
  \setbox0=\hbox{\usebeamerfont{frametitle}\insertframetitle}%
  \@titletextwidth=\wd0%
  \setbox1=\hbox{\usebeamerfont{frametitle}8ML}%
  \@titletextheight=\ht1%
  % Compute height of frametitle region (including top margin)
  \newdimen\frametitle@height%
  \frametitle@height=\trek@elbow@height%
  \advance \frametitle@height by \trek@margin%
  % Origin of the "cursor" (right-most knobbly thing)
  \newdimen\cursor@x
  \newdimen\cursor@y
  \cursor@x=\paperwidth
  \advance \cursor@x by -\the\trek@margin
  \advance \cursor@x by -\the\trek@cursorwidth
  \cursor@y=\trek@elbow@height
  \advance \cursor@y by -\the\@titletextheight
  % Origin of the title (center of baseline)
  \newdimen\title@x
  \newdimen\title@y
  \title@x=-\the\@titletextwidth
  \divide \title@x by 2
  \advance \title@x by \the\cursor@x
  \advance \title@x by -\the\trek@titlegap
  \title@y=\cursor@y
  % Origin and width of the "elbow"
  \newdimen\elbow@x
  \newdimen\elbow@y
  \elbow@x=-\the\@titletextwidth
  \divide \elbow@x by 2
  \advance \elbow@x by \title@x
  \advance \elbow@x by -\the\trek@titlegap
  \elbow@y=\cursor@y
  \newdimen\elbow@width
  \elbow@width=\the\elbow@x
  \advance \elbow@width by -\the\trek@margin
  % Typeset the title
  \leavevmode%
  \hskip-\the\trek@full@sidebar@width% skip horizontally back across the sidebar width
  \hbox{%
    \begin{beamercolorbox}[wd=\paperwidth,ht=\the\frametitle@height,left]{frametitle}%
      \begin{tikzpicture}
        \useasboundingbox (0,0) rectangle (\paperwidth,\the\frametitle@height);
        %\draw [draw=none,fill=red] (0,0) rectangle (\paperwidth,\the\frametitle@height);
        % cursor at the right
        \draw (\the\cursor@x,\the\cursor@y) node [
          trek cursor,
          trek/cursor/width=\the\trek@cursorwidth,
          trek/cursor/height=\the\@titletextheight
        ]{};
        % title text
        \draw (\the\title@x,\the\title@y) node [anchor=base,inner sep=0]
          {\usebeamerfont{frametitle}\insertframetitle};
        % elbow
        \draw (\the\elbow@x,\the\elbow@y) node [
          trek elbow,
          trek/elbow/bar height=\the\@titletextheight,
          trek/elbow/height=\the\trek@elbow@height,
          trek/elbow/sidebar width=\the\trek@sidebar@width,
          trek/elbow/outer radius=\the\trek@elbow@outer@radius,
          trek/elbow/inner radius=\the\trek@elbow@inner@radius,
          trek/elbow/width=\the\elbow@width
        ]{};
      \end{tikzpicture}
    \end{beamercolorbox}
  }%
}

\makeatother

\mode<all>